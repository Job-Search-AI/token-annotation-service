<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í† í° íƒœê¹… ì„œë¹„ìŠ¤ (NER)</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Inter í°íŠ¸ ì„¤ì • */
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap");
      body {
        font-family: "Inter", sans-serif;
        background-color: #f7f9fb;
      }
      /* íƒœê¹…ëœ í† í° ìƒ‰ìƒ ë§¤í•‘ */
      .bg-B-JOB {
        background-color: #6366f1;
      } /* Indigo */
      .bg-I-JOB {
        background-color: #818cf8;
      }
      .bg-B-CAR {
        background-color: #22c55e;
      } /* Green */
      .bg-I-CAR {
        background-color: #4ade80;
      }
      .bg-B-EDU {
        background-color: #f97316;
      } /* Orange */
      .bg-I-EDU {
        background-color: #fb923c;
      }
      .bg-B-LOC {
        background-color: #06b6d4;
      } /* Cyan */
      .bg-I-LOC {
        background-color: #22d3ee;
      }
      .bg-O {
        background-color: #94a3b8;
      } /* Slate */

      .token-tag {
        color: white;
        padding: 4px 8px;
        margin: 2px;
        border-radius: 6px;
        transition: transform 0.1s, box-shadow 0.1s;
        cursor: pointer;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        font-weight: 500;
      }

      .token-tag:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .current-token-wrapper {
        min-height: 150px; /* ë ˆì´ì•„ì›ƒ ì•ˆì •ì„± í™•ë³´ */
      }
    </style>
  </head>
  <body class="p-4 md:p-8">
    <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
    <div id="app" class="max-w-6xl mx-auto">
      <header class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-gray-800">
          í† í° íƒœê¹… ì„œë¹„ìŠ¤ (NER íƒœê¹…)
        </h1>
        <p class="text-gray-500">
          ê° í† í°ì— 'ì§ë¬´', 'ê²½ë ¥', 'í•™ë ¥', 'ì§€ì—­' ë˜ëŠ” 'O(ê¸°íƒ€)' íƒœê·¸ë¥¼
          í• ë‹¹í•˜ì„¸ìš”.
        </p>
      </header>

      <!-- 1. ì…ë ¥ ì„¤ì • ë° ì§„í–‰ ìƒí™© ì˜ì—­ -->
      <section
        id="setup-section"
        class="bg-white p-6 rounded-xl shadow-lg mb-8"
      >
        <!-- FLEX CONTAINER: ì œëª©ê³¼ ë²„íŠ¼ì„ ê°™ì€ ì¸µì— ê°€ë¡œë¡œ ë°°ì¹˜ -->
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-semibold text-gray-700">
            ì…ë ¥ ëª¨ë¸ ë° ë¬¸ì¥ ì„¤ì •
          </h2>

          <!-- í† í¬ë‚˜ì´ì € ID ìˆ˜ì • ë²„íŠ¼ (âš™ï¸ ì´ëª¨í‹°ì½˜ë§Œ, ë°°ê²½/ëª¨ì„œë¦¬ ë³€ê²½) -->
          <button
            id="open-tokenizer-modal-btn"
            title="í† í¬ë‚˜ì´ì € ID ìˆ˜ì •"
            class="bg-gray-200 text-gray-800 w-10 h-10 rounded-lg text-lg font-medium hover:bg-gray-300 transition shadow-sm border border-gray-300 flex items-center justify-center"
          >
            âš™ï¸
          </button>
        </div>
        <!-- FLEX CONTAINER ë -->

        <div class="flex flex-col md:flex-row gap-4 mb-4">
          <textarea
            id="input-sentences"
            class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition"
            rows="3"
            placeholder="í•œ ì¤„ì— í•˜ë‚˜ì˜ ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: ì‹ ì… ê³ ì¡¸ í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì ì„œìš¸ ê³µê³  ì•Œë ¤ì¤˜.)"
          ></textarea>
          <button
            id="start-btn"
            class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-indigo-700 transition duration-150 shadow-md whitespace-nowrap"
          >
            ì‘ì—… ì‹œì‘ / ì¬ì‹œì‘
          </button>
        </div>

        <!-- í† í¬ë‚˜ì´ì € ë¡œë”© ìƒíƒœ ë° ì§„í–‰ ìƒí™© í‘œì‹œ (ë ˆì´ì•„ì›ƒ ë¶„ë¦¬) -->
        <div id="progress-container" class="mt-2">
          <!-- 1. ë¡œë”© ìƒíƒœ/ëª¨ë¸ ID -->
          <p id="progress-status-line" class="text-sm text-gray-600">
            í† í¬ë‚˜ì´ì € ë¡œë”© ì „... (klue/bert-base)
          </p>
          <!-- 2. ë¬¸ì¥ ì¹´ìš´íŠ¸ (ìƒˆ ì¤„) -->
          <p
            id="progress-count-line"
            class="text-sm text-gray-500 mt-0.5 font-medium"
          >
            í˜„ì¬ ì§„í–‰: 0 / 0 ë¬¸ì¥
          </p>
        </div>
      </section>

      <!-- 2. í† í° íƒœê¹… ì˜ì—­ (ì‘ì—… ì¤‘ì¼ ë•Œë§Œ í‘œì‹œ) -->
      <section
        id="annotation-section"
        class="bg-white p-8 rounded-xl shadow-lg mb-8 hidden"
      >
        <h2 class="text-xl font-semibold mb-6 text-gray-700">í† í° íƒœê¹…</h2>

        <!-- í˜„ì¬ í† í° í‘œì‹œ -->
        <div
          class="current-token-wrapper flex flex-col items-center justify-center mb-8"
        >
          <!-- ë³€ê²½: h-24, flex, items-center, justify-centerë¥¼ ì¶”ê°€í•˜ì—¬ ë†’ì´ë¥¼ ê³ ì •í•˜ê³  í…ìŠ¤íŠ¸ë¥¼ ì¤‘ì•™ì— ë°°ì¹˜ -->
          <span
            class="text-6xl font-extrabold text-indigo-700 h-24 flex items-center justify-center"
            id="current-token"
          ></span>
          <!-- ë³€ê²½: h-5ë¥¼ ì¶”ê°€í•˜ì—¬ ì„¤ëª… í…ìŠ¤íŠ¸ ì˜ì—­ì˜ ë†’ì´ë¥¼ ê³ ì • -->
          <p class="text-sm text-gray-400 mt-2 h-5">({}ë²ˆì§¸ í† í°)</p>
        </div>

        <!-- íƒœê·¸ í• ë‹¹ ë²„íŠ¼ (ìˆ«ì ë‹¨ì¶•í‚¤ ì¶”ê°€) -->
        <div
          id="tag-buttons"
          class="grid grid-cols-2 md:grid-cols-5 gap-3 max-w-2xl mx-auto"
        >
          <button
            data-tag="JOB"
            class="tag-btn bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-150"
          >
            1. ì§ë¬´ (JOB)
          </button>
          <button
            data-tag="CAR"
            class="tag-btn bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-150"
          >
            2. ê²½ë ¥ (CAR)
          </button>
          <button
            data-tag="EDU"
            class="tag-btn bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-150"
          >
            3. í•™ë ¥ (EDU)
          </button>
          <button
            data-tag="LOC"
            class="tag-btn bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-150"
          >
            4. ì§€ì—­ (LOC)
          </button>
          <!-- 'O (ê¸°íƒ€)' ë²„íŠ¼ì„ 'X (O íƒœê¹…)'ìœ¼ë¡œ ë³€ê²½ -->
          <button
            data-tag="O"
            class="tag-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-lg shadow-md transition duration-150"
          >
            5. X (O íƒœê¹…)
          </button>
        </div>

        <!-- ë¬¸ì¥ ì™„ë£Œ/ë‹¤ìŒ ë¬¸ì¥ ë²„íŠ¼ -->
        <div class="text-center mt-6">
          <!-- ë³€ê²½: 'hidden'ì„ 'invisible opacity-0'ë¡œ êµì²´í•˜ì—¬ ê³µê°„ì€ ìœ ì§€í•˜ë˜ ì‹œê°ì ìœ¼ë¡œë§Œ ìˆ¨ê¹ë‹ˆë‹¤. -->
          <button
            id="next-input-btn"
            class="bg-blue-600 text-white px-8 py-3 rounded-lg font-medium hover:bg-blue-700 transition duration-150 shadow-lg invisible opacity-0"
          >
            ë‹¤ìŒ ë¬¸ì¥ìœ¼ë¡œ â†’
          </button>
        </div>
      </section>

      <!-- 3. ì‹¤ì‹œê°„ ì§„í–‰ ìƒí™© ë° ìˆ˜ì • ì˜ì—­ -->
      <section
        id="status-section"
        class="bg-white p-6 rounded-xl shadow-lg mb-8 hidden"
      >
        <h2 class="text-xl font-semibold mb-4 text-gray-700">
          ì‹¤ì‹œê°„ íƒœê¹… ìƒíƒœ (í´ë¦­í•˜ì—¬ ìˆ˜ì •)
        </h2>
        <p class="text-sm text-gray-500 mb-3">
          <span class="font-bold text-gray-700">í˜„ì¬ ë¬¸ì¥:</span>
          <span id="current-sentence-display"></span>
        </p>

        <!-- íƒœê·¸ ëª©ë¡ í‘œì‹œ -->
        <div
          id="token-list"
          class="flex flex-wrap gap-2 p-3 border border-gray-200 rounded-lg min-h-12 bg-gray-50"
        >
          <p class="text-gray-400 text-sm italic">
            í† í°ì„ í• ë‹¹í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
          </p>
        </div>

        <!-- JSON ê²°ê³¼ ì‹¤ì‹œê°„ í‘œì‹œ -->
        <h3 class="text-lg font-medium mt-6 mb-2 text-gray-700">
          í˜„ì¬ JSON ê²°ê³¼:
        </h3>
        <pre
          id="current-json-output"
          class="bg-gray-800 text-green-300 p-4 rounded-lg overflow-x-auto text-sm"
        >
{}</pre
        >
      </section>

      <!-- 4. ìµœì¢… ê²°ê³¼ ì˜ì—­ -->
      <section
        id="final-results-section"
        class="bg-white p-6 rounded-xl shadow-lg mb-8 hidden"
      >
        <h2 class="text-xl font-semibold mb-4 text-gray-700">
          ìµœì¢… ê²°ê³¼ë¬¼ (<span id="final-count">0</span>ê°œ ë¬¸ì¥ ì²˜ë¦¬ ì™„ë£Œ)
        </h2>
        <p class="text-gray-600 mb-4">
          í˜„ì¬ê¹Œì§€ ì²˜ë¦¬ëœ ëª¨ë“  ì…ë ¥ ë¬¸ì¥ì— ëŒ€í•œ íƒœê¹… ê²°ê³¼ì…ë‹ˆë‹¤. ì•„ë˜ JSONì„
          ë³µì‚¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
        <pre
          id="final-json-output"
          class="bg-gray-800 text-yellow-300 p-4 rounded-lg overflow-x-auto text-sm max-h-96"
        >
[]</pre
        >
        <div class="flex gap-3 mt-4">
          <button
            id="copy-json-btn"
            class="bg-purple-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-purple-700 transition duration-150 shadow-md"
          >
            JSON ë³µì‚¬
          </button>
          <button
            id="save-to-storage-btn"
            class="bg-green-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-700 transition duration-150 shadow-md"
          >
            ğŸ’¾ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
          </button>
        </div>
      </section>

      <!-- 5. ì €ì¥ëœ ì‘ì—… ëª©ë¡ ì„¹ì…˜ -->
      <section
        id="saved-data-section"
        class="bg-white p-6 rounded-xl shadow-lg mb-8"
      >
        <h2 class="text-xl font-semibold mb-4 text-gray-700">
          ì €ì¥ëœ ì‘ì—… ëª©ë¡
        </h2>
        <p class="text-gray-600 mb-4">
          ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ëœ ì‘ì—…ë“¤ì…ë‹ˆë‹¤. ë¶ˆëŸ¬ì™€ì„œ ì´ì–´ì„œ ì‘ì—…í•  ìˆ˜
          ìˆìŠµë‹ˆë‹¤.
        </p>
        <div
          id="saved-data-list"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
        >
          <!-- ì €ì¥ëœ ë°ì´í„° ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
      </section>

      <!-- ì»¤ìŠ¤í…€ ëª¨ë‹¬ (ê²½ê³ /í™•ì¸ìš©) -->
      <div
        id="custom-modal"
        class="fixed inset-0 bg-black bg-opacity-50 z-50 items-center justify-center hidden"
      >
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4">
          <h3 id="modal-title" class="text-xl font-bold mb-3 text-gray-800">
            ì•Œë¦¼
          </h3>
          <div id="modal-content-container">
            <!-- Dynamic content: message or input goes here -->
            <p class="text-gray-700 mb-4">ë‚´ìš©</p>
          </div>
          <div class="flex justify-end space-x-3">
            <button
              id="modal-close-btn"
              class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition"
            >
              ë‹«ê¸°
            </button>
            <button
              id="modal-action-btn"
              class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition hidden"
            >
              í™•ì¸
            </button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      // Hugging Face Transformers.js ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ AutoTokenizerë¥¼ ì§ì ‘ ê°€ì ¸ì˜µë‹ˆë‹¤.
      import { AutoTokenizer } from "https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.7.4";

      // ì•± ìƒíƒœ ë³€ìˆ˜
      let globalState = {
        inputs: [], // ëª¨ë“  ì…ë ¥ ë¬¸ì¥
        currentInputIndex: 0, // í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ë¬¸ì¥ ì¸ë±ìŠ¤
        currentTokenIndex: 0, // í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ í† í° ì¸ë±ìŠ¤
        currentTokens: [], // í˜„ì¬ ë¬¸ì¥ì˜ í† í° ë°°ì—´
        currentTokenTags: [], // í˜„ì¬ ë¬¸ì¥ì˜ íƒœê·¸ ë°°ì—´
        allResults: [], // ëª¨ë“  ì™„ë£Œëœ ê²°ê³¼
        isEditingTokenIndex: -1, // ìˆ˜ì • ì¤‘ì¸ í† í°ì˜ ì¸ë±ìŠ¤ (-1ì´ë©´ ìˆ˜ì • ì•„ë‹˜)
        loadedDataId: null, // í˜„ì¬ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ì˜ ID (ì´ì–´ì„œ ì‘ì—… ì‹œ ì‚¬ìš©)
      };

      // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ê´€ë ¨ ìƒìˆ˜
      const STORAGE_KEY = "tokenAnnotationSaves";

      // LLM í† í¬ë‚˜ì´ì € ìƒíƒœ ë³€ìˆ˜ (Hugging Face Transformers.js ì‚¬ìš©)
      let tokenizer = null;
      let isTokenizerReady = false;
      let loadedModelId = null; // í˜„ì¬ ë¡œë“œëœ ëª¨ë¸ ID
      let pendingModelId = "klue/bert-base"; // ì‚¬ìš©ìê°€ ì„¤ì •í•œ (ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì€) ID

      // UI ìš”ì†Œ ìºì‹±
      const elements = {
        inputSentences: document.getElementById("input-sentences"),
        startBtn: document.getElementById("start-btn"),

        // ë³€ê²½ëœ ìš”ì†Œ ID ë°˜ì˜
        progressStatusLine: document.getElementById("progress-status-line"),
        progressCountLine: document.getElementById("progress-count-line"),

        annotationSection: document.getElementById("annotation-section"),
        statusSection: document.getElementById("status-section"),
        finalResultsSection: document.getElementById("final-results-section"),
        currentToken: document.getElementById("current-token"),
        tokenList: document.getElementById("token-list"),
        currentJsonOutput: document.getElementById("current-json-output"),
        finalJsonOutput: document.getElementById("final-json-output"),
        nextInputBtn: document.getElementById("next-input-btn"),
        tagButtons: document.querySelectorAll(".tag-btn"),
        currentSentenceDisplay: document.getElementById(
          "current-sentence-display"
        ),
        copyJsonBtn: document.getElementById("copy-json-btn"),
        finalCount: document.getElementById("final-count"),

        // ìƒˆ ìš”ì†Œ
        openTokenizerModalBtn: document.getElementById(
          "open-tokenizer-modal-btn"
        ),
        saveToStorageBtn: document.getElementById("save-to-storage-btn"),
        savedDataList: document.getElementById("saved-data-list"),

        // ëª¨ë‹¬ ê´€ë ¨ ìš”ì†Œ (ìˆ˜ì •ë¨)
        modal: document.getElementById("custom-modal"),
        modalTitle: document.getElementById("modal-title"),
        modalContentContainer: document.getElementById(
          "modal-content-container"
        ),
        modalCloseBtn: document.getElementById("modal-close-btn"),
        modalActionBtn: document.getElementById("modal-action-btn"),
      };

      // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

      // --- ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ê´€ë ¨ í•¨ìˆ˜ ---

      /**
       * ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ëª¨ë“  ì €ì¥ëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
       * @returns {Array} ì €ì¥ëœ ë°ì´í„° ë°°ì—´
       */
      const getAllSavedData = () => {
        try {
          const data = localStorage.getItem(STORAGE_KEY);
          if (!data) return [];
          const parsed = JSON.parse(data);
          // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ (timestamp ê¸°ì¤€)
          return parsed.sort(
            (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
          );
        } catch (error) {
          console.error("ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë°ì´í„° ì½ê¸° ì˜¤ë¥˜:", error);
          return [];
        }
      };

      /**
       * ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ë°ì´í„° ì €ì¥
       * @param {string} name - ì €ì¥í•  ë°ì´í„° ì´ë¦„
       * @returns {boolean} ì €ì¥ ì„±ê³µ ì—¬ë¶€
       */
      const saveToLocalStorage = (name) => {
        try {
          if (!name || name.trim() === "") {
            showModal("ê²½ê³ ", "ì €ì¥ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return false;
          }

          if (name.length > 50) {
            showModal("ê²½ê³ ", "ì €ì¥ ì´ë¦„ì€ 50ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            return false;
          }

          if (globalState.allResults.length === 0) {
            showModal(
              "ê²½ê³ ",
              "ì €ì¥í•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íƒœê¹… ì‘ì—…ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”."
            );
            return false;
          }

          const allData = getAllSavedData();

          // ê°™ì€ ì´ë¦„ì´ ìˆëŠ”ì§€ í™•ì¸
          const existingIndex = allData.findIndex((item) => item.name === name);

          const newData = {
            id: globalState.loadedDataId || Date.now().toString(),
            name: name.trim(),
            timestamp: new Date().toISOString(),
            modelId: loadedModelId || pendingModelId,
            results: JSON.parse(JSON.stringify(globalState.allResults)),
          };

          if (existingIndex !== -1) {
            // ë®ì–´ì“°ê¸°
            allData[existingIndex] = newData;
          } else {
            // ìƒˆë¡œ ì¶”ê°€
            allData.push(newData);
          }

          localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
          globalState.loadedDataId = newData.id; // ì €ì¥ í›„ ID ì—…ë°ì´íŠ¸

          renderSavedDataList();
          showModal(
            "ì €ì¥ ì™„ë£Œ",
            `"${name}" ì‘ì—…ì´ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`
          );
          return true;
        } catch (error) {
          console.error("ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì˜¤ë¥˜:", error);
          if (error.name === "QuotaExceededError") {
            showModal(
              "ì €ì¥ ì‹¤íŒ¨",
              "ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ìš©ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì¼ë¶€ ë°ì´í„°ë¥¼ ì‚­ì œí•´ì£¼ì„¸ìš”."
            );
          } else {
            showModal("ì €ì¥ ì‹¤íŒ¨", "ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
          return false;
        }
      };

      /**
       * ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
       * @param {string} id - ë¶ˆëŸ¬ì˜¬ ë°ì´í„° ID
       */
      const loadFromLocalStorage = (id) => {
        try {
          const allData = getAllSavedData();
          const data = allData.find((item) => item.id === id);

          if (!data) {
            showModal("ì˜¤ë¥˜", "í•´ë‹¹ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
          }

          // ë°ì´í„° ë¡œë“œ
          globalState.allResults = JSON.parse(JSON.stringify(data.results));
          globalState.loadedDataId = data.id;
          pendingModelId = data.modelId;

          // í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚´ìš© ì´ˆê¸°í™”
          globalState.inputs = [];
          globalState.currentInputIndex = 0;
          globalState.currentTokens = [];
          globalState.currentTokenTags = [];
          globalState.currentTokenIndex = 0;

          // ì…ë ¥ì°½ ë¹„ìš°ê¸°
          elements.inputSentences.value = "";

          renderUI();
          showModal("ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ", `"${data.name}" í”„ë¡œì íŠ¸ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
        } catch (error) {
          console.error("ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
          showModal(
            "ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨",
            "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
          );
        }
      };

      /**
       * ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ë°ì´í„° ì‚­ì œ
       * @param {string} id - ì‚­ì œí•  ë°ì´í„° ID
       */
      const deleteFromLocalStorage = (id) => {
        try {
          const allData = getAllSavedData();
          const filtered = allData.filter((item) => item.id !== id);

          localStorage.setItem(STORAGE_KEY, JSON.stringify(filtered));
          renderSavedDataList();
          showModal("ì‚­ì œ ì™„ë£Œ", "ì‘ì—…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (error) {
          console.error("ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì‚­ì œ ì˜¤ë¥˜:", error);
          showModal("ì‚­ì œ ì‹¤íŒ¨", "ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      };

      /**
       * ì €ì¥ëœ ë°ì´í„° ëª©ë¡ UI ë Œë”ë§
       */
      const renderSavedDataList = () => {
        const allData = getAllSavedData();

        if (allData.length === 0) {
          elements.savedDataList.innerHTML = `
            <div class="col-span-full text-center py-8">
              <p class="text-gray-400 text-lg">ì €ì¥ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>
              <p class="text-gray-500 text-sm mt-2">íƒœê¹… ì‘ì—…ì„ ì™„ë£Œí•œ í›„ "ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì €ì¥" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
            </div>
          `;
          return;
        }

        elements.savedDataList.innerHTML = allData
          .map((data) => {
            const date = new Date(data.timestamp);
            const formattedDate = date.toLocaleString("ko-KR", {
              year: "numeric",
              month: "2-digit",
              day: "2-digit",
              hour: "2-digit",
              minute: "2-digit",
            });

            return `
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow bg-gray-50">
              <h3 class="font-bold text-lg text-gray-800 mb-2 truncate" title="${
                data.name
              }">
                ${data.name}
              </h3>
              <div class="text-sm text-gray-600 space-y-1 mb-3">
                <p>ğŸ“… ${formattedDate}</p>
                <p>ğŸ“ ${data.results.length}ê°œ ë¬¸ì¥</p>
                <p class="truncate" title="${data.modelId}">ğŸ¤– ${
              data.modelId
            }</p>
              </div>
              <div class="flex gap-2">
                <button
                  onclick="handleLoadData('${data.id}')"
                  class="flex-1 bg-blue-500 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-blue-600 transition"
                >
                  ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
                <button
                  onclick="handleDeleteData('${data.id}', '${data.name.replace(
              /'/g,
              "\\'"
            )}')"
                  class="bg-red-500 text-white px-3 py-2 rounded-lg text-sm font-medium hover:bg-red-600 transition"
                >
                  ì‚­ì œ
                </button>
              </div>
            </div>
          `;
          })
          .join("");
      };

      /**
       * ì €ì¥ ì´ë¦„ ì…ë ¥ ëª¨ë‹¬ í‘œì‹œ
       */
      const showSaveModal = () => {
        elements.modalTitle.textContent = "ì‘ì—… ì €ì¥";

        // ê¸°ë³¸ ì´ë¦„ ìƒì„± - ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ê·¸ ì´ë¦„ ì‚¬ìš©
        let defaultName;
        if (globalState.loadedDataId) {
          const allData = getAllSavedData();
          const loadedData = allData.find(
            (item) => item.id === globalState.loadedDataId
          );
          defaultName = loadedData ? loadedData.name : `ìƒˆ í”„ë¡œì íŠ¸`;
        } else {
          defaultName = `ìƒˆ í”„ë¡œì íŠ¸`;
        }

        elements.modalContentContainer.innerHTML = `
          <p class="text-gray-700 mb-3 text-sm">
            ì €ì¥í•  ì‘ì—…ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.
          </p>
          <input 
            type="text" 
            id="modal-save-name-input" 
            value="${defaultName}" 
            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 transition" 
            placeholder="ì‘ì—… ì´ë¦„"
            maxlength="50">
          <p class="text-sm text-gray-500 mt-2">ê°™ì€ ì´ë¦„ì´ ìˆìœ¼ë©´ ë®ì–´ì”ë‹ˆë‹¤.</p>
        `;

        elements.modalActionBtn.classList.remove("hidden");
        elements.modalActionBtn.textContent = "ì €ì¥";
        elements.modalActionBtn.className =
          "bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition";
        elements.modalCloseBtn.textContent = "ì·¨ì†Œ";

        elements.modalActionBtn.onclick = () => {
          const inputElement = document.getElementById("modal-save-name-input");
          const name = inputElement.value.trim();

          if (saveToLocalStorage(name)) {
            elements.modal.classList.add("hidden");
            elements.modal.classList.remove("flex");
          }
        };

        elements.modalCloseBtn.onclick = () => {
          elements.modal.classList.add("hidden");
          elements.modal.classList.remove("flex");
        };

        elements.modal.classList.remove("hidden");
        elements.modal.classList.add("flex");

        setTimeout(() => {
          const input = document.getElementById("modal-save-name-input");
          if (input) {
            input.focus();
            input.select();
          }
        }, 100);
      };

      // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ (HTML onclickì—ì„œ ì‚¬ìš©)
      window.handleLoadData = (id) => {
        // í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚´ìš©ì´ ìˆëŠ”ì§€ í™•ì¸
        if (
          globalState.currentTokens.length > 0 ||
          globalState.inputs.length > 0
        ) {
          elements.modalTitle.textContent = "ë¶ˆëŸ¬ì˜¤ê¸° í™•ì¸";
          elements.modalContentContainer.innerHTML = `
            <p class="text-gray-700 mb-4">í˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚´ìš©ì´ ìˆìŠµë‹ˆë‹¤.<br>ë¶ˆëŸ¬ì˜¤ë©´ í˜„ì¬ ë‚´ìš©ì´ ì‚¬ë¼ì§‘ë‹ˆë‹¤.<br><br>ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
          `;
          elements.modalActionBtn.classList.remove("hidden");
          elements.modalActionBtn.textContent = "ë¶ˆëŸ¬ì˜¤ê¸°";
          elements.modalActionBtn.className =
            "bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition";
          elements.modalCloseBtn.textContent = "ì·¨ì†Œ";

          elements.modalActionBtn.onclick = () => {
            loadFromLocalStorage(id);
            elements.modal.classList.add("hidden");
            elements.modal.classList.remove("flex");
          };

          elements.modalCloseBtn.onclick = () => {
            elements.modal.classList.add("hidden");
            elements.modal.classList.remove("flex");
          };

          elements.modal.classList.remove("hidden");
          elements.modal.classList.add("flex");
        } else {
          loadFromLocalStorage(id);
        }
      };

      window.handleDeleteData = (id, name) => {
        elements.modalTitle.textContent = "ì‚­ì œ í™•ì¸";
        elements.modalContentContainer.innerHTML = `
          <p class="text-gray-700 mb-4">"${name}" ì‘ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><br>ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        `;
        elements.modalActionBtn.classList.remove("hidden");
        elements.modalActionBtn.textContent = "ì‚­ì œ";
        elements.modalActionBtn.className =
          "bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition";
        elements.modalCloseBtn.textContent = "ì·¨ì†Œ";

        elements.modalActionBtn.onclick = () => {
          deleteFromLocalStorage(id);
          elements.modal.classList.add("hidden");
          elements.modal.classList.remove("flex");
        };

        elements.modalCloseBtn.onclick = () => {
          elements.modal.classList.add("hidden");
          elements.modal.classList.remove("flex");
        };

        elements.modal.classList.remove("hidden");
        elements.modal.classList.add("flex");
      };

      // --- ê¸°ì¡´ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

      /**
       * ì»¤ìŠ¤í…€ ì•Œë¦¼ ëª¨ë‹¬ í‘œì‹œ (ê°„ë‹¨í•œ ì•Œë¦¼ìš©)
       * @param {string} title - ëª¨ë‹¬ ì œëª©
       * @param {string} message - ëª¨ë‹¬ ë©”ì‹œì§€ (HTML ê°€ëŠ¥)
       */
      const showModal = (title, message) => {
        // ë‚´ë¶€ ì»¨í…ì¸  ì´ˆê¸°í™” ë° ë©”ì‹œì§€ ì‚½ì…
        elements.modalContentContainer.innerHTML = `<p id="modal-message" class="text-gray-700 mb-4">${message}</p>`;

        elements.modalTitle.textContent = title;
        elements.modalActionBtn.classList.add("hidden"); // ì•¡ì…˜ ë²„íŠ¼ ìˆ¨ê¹€
        elements.modalCloseBtn.textContent = "í™•ì¸"; // ë‹«ê¸° ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½

        elements.modal.classList.remove("hidden");
        elements.modal.classList.add("flex");

        // ëª¨ë‹¬ì„ ë‹«ëŠ” ê¸°ë³¸ í•¸ë“¤ëŸ¬ ì„¤ì •
        elements.modalCloseBtn.onclick = () => {
          elements.modal.classList.add("hidden");
          elements.modal.classList.remove("flex");
        };
        elements.modalActionBtn.onclick = null; // ì•¡ì…˜ ì´ˆê¸°í™”
      };

      /**
       * í† í¬ë‚˜ì´ì € ì„¤ì • ëª¨ë‹¬ í‘œì‹œ ë° ì…ë ¥ ì²˜ë¦¬
       */
      const openTokenizerConfigModal = () => {
        elements.modalTitle.textContent = "Hugging Face í† í¬ë‚˜ì´ì € ID ì„¤ì •";

        // Input í•„ë“œì™€ ë©”ì‹œì§€ë¥¼ í¬í•¨í•˜ëŠ” ë™ì  ì½˜í…ì¸  ìƒì„±
        elements.modalContentContainer.innerHTML = `
                <p class="text-gray-700 mb-3 text-sm">
                    í† í°í™”ì— ì‚¬ìš©í•  Hugging Face ëª¨ë¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: <span class="font-mono text-indigo-600">klue/bert-base</span>)
                </p>
                <input type="text" id="modal-tokenizer-input" value="${pendingModelId}" 
                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 transition" 
                       placeholder="ëª¨ë¸ ID">
                <p class="text-sm text-gray-500 mt-2">í˜„ì¬ ë¡œë“œëœ ëª¨ë¸: ${
                  loadedModelId || "ì—†ìŒ"
                }</p>
            `;

        // ì•¡ì…˜ ë²„íŠ¼ í‘œì‹œ ë° í…ìŠ¤íŠ¸/í•¸ë“¤ëŸ¬ ì„¤ì •
        elements.modalActionBtn.classList.remove("hidden");
        elements.modalActionBtn.textContent = "ì ìš©";
        elements.modalCloseBtn.textContent = "ì·¨ì†Œ";

        // ì ìš© ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬
        elements.modalActionBtn.onclick = () => {
          const inputElement = document.getElementById("modal-tokenizer-input");
          const newModelId = inputElement.value.trim();

          if (newModelId) {
            const oldModelId = pendingModelId;
            pendingModelId = newModelId; // ì„¤ì • ì™„ë£Œ
            elements.modal.classList.add("hidden");
            elements.modal.classList.remove("flex");

            // ë§Œì•½ IDê°€ ë³€ê²½ë˜ì—ˆê±°ë‚˜ ë¡œë“œëœ ì ì´ ì—†ë‹¤ë©´, ì‚¬ìš©ìì—ê²Œ 'ì‘ì—… ì‹œì‘'ì„ ëˆ„ë¥´ë¼ê³  ì•Œë¦¼
            if (newModelId !== loadedModelId && newModelId !== oldModelId) {
              showModal(
                "ì•Œë¦¼",
                `í† í¬ë‚˜ì´ì € IDê°€ <span class="font-bold text-indigo-600">${newModelId}</span>ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. <br>ë³€ê²½ ì‚¬í•­ì„ ì ìš©í•˜ë ¤ë©´ **'ì‘ì—… ì‹œì‘ / ì¬ì‹œì‘'** ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.`
              );
            } else {
              showModal(
                "ì•Œë¦¼",
                `í† í¬ë‚˜ì´ì € IDê°€ <span class="font-bold text-indigo-600">${newModelId}</span>ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`
              );
            }
            renderUI(); // UI ì—…ë°ì´íŠ¸ë¥¼ í†µí•´ pendingModelIdë¥¼ ë°˜ì˜
          } else {
            // ì…ë ¥ì´ ë¹„ì–´ìˆìœ¼ë©´ ê²½ê³ 
            showModal("ê²½ê³ ", "í† í¬ë‚˜ì´ì € IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          }
        };

        // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ (ëª¨ë‹¬ ë‹«ê¸°)
        elements.modalCloseBtn.onclick = () => {
          elements.modal.classList.add("hidden");
          elements.modal.classList.remove("flex");
        };

        elements.modal.classList.remove("hidden");
        elements.modal.classList.add("flex");
        // ëª¨ë‹¬ ì—´ë¦´ ë•Œ inputì— í¬ì»¤ìŠ¤
        setTimeout(() => {
          document.getElementById("modal-tokenizer-input")?.focus();
        }, 100);
      };

      // íƒœê·¸ì— ë”°ë¥¸ ë°°ê²½ ìƒ‰ìƒ í´ë˜ìŠ¤ ë°˜í™˜
      const getTagColorClass = (tag) => {
        if (!tag) return "bg-gray-300 text-gray-700";
        const baseTag = tag.replace(/^[BI]-/, "");
        return `bg-${tag} text-white`;
      };

      /**
       * í† í°ì„ LLM í† í¬ë‚˜ì´ì € ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬
       * @param {string} sentence - í† í°í™”í•  ë¬¸ì¥
       * @returns {string[]} í† í° ë¦¬ìŠ¤íŠ¸
       */
      const tokenize = (sentence) => {
        if (!tokenizer) {
          console.error("í† í¬ë‚˜ì´ì €ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
          return [];
        }

        // AutoTokenizerì˜ tokenize ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ í† í°í™” ìˆ˜í–‰
        const tokens = tokenizer.tokenize(sentence);

        // WordPiece ê¸°ë°˜ í† í¬ë‚˜ì´ì €ì˜ ## ì ‘ë‘ì‚¬ ì œê±°
        const filteredTokens = tokens
          .map((token) => token.replace(/^##/, ""))
          .filter((t) => t.length > 0); // ë¹ˆ ë¬¸ìì—´ í† í° ì œê±°

        return filteredTokens;
      };

      // --- í† í¬ë‚˜ì´ì € ë¡œë”© ë¡œì§ ---
      /**
       * ì§€ì •ëœ ëª¨ë¸ IDë¡œ í† í¬ë‚˜ì´ì €ë¥¼ ì´ˆê¸°í™”í•˜ê³  ë¡œë“œí•©ë‹ˆë‹¤.
       * @param {string} modelId - Hugging Face ëª¨ë¸ ID (ì˜ˆ: 'klue/bert-base')
       */
      const initializeTokenizer = async (modelId) => {
        if (!modelId) {
          showModal("ê²½ê³ ", "í† í¬ë‚˜ì´ì € IDë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
          isTokenizerReady = false;
          loadedModelId = null;
          elements.progressStatusLine.innerHTML = `<span class="text-red-500 font-bold">ëª¨ë¸ IDê°€ í•„ìš”í•©ë‹ˆë‹¤.</span> (${pendingModelId})`;
          return;
        }

        isTokenizerReady = false;
        loadedModelId = null;
        elements.progressStatusLine.innerHTML = `í† í¬ë‚˜ì´ì € ë¡œë”© ì¤‘... (${modelId}) <span class="text-indigo-500 font-bold">ìµœì´ˆ ë¡œë”© ì‹œ ìˆ˜ì‹­ ì´ˆê°€ ì†Œìš”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>`;

        try {
          tokenizer = await AutoTokenizer.from_pretrained(modelId);

          isTokenizerReady = true;
          loadedModelId = modelId;

          // ë¡œë”© ì™„ë£Œ ì‹œ ë©”ì‹œì§€ ì—…ë°ì´íŠ¸ëŠ” renderUIì—ì„œ ì²˜ë¦¬
          renderUI();
        } catch (error) {
          console.error("í† í¬ë‚˜ì´ì € ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
          elements.progressStatusLine.innerHTML = `<span class="text-red-500 font-bold">í† í¬ë‚˜ì´ì € ë¡œë”© ì‹¤íŒ¨.</span> ID: ${modelId}`;
          showModal(
            "ì˜¤ë¥˜",
            `í† í¬ë‚˜ì´ì € ëª¨ë¸ (${modelId}) ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. IDë¥¼ í™•ì¸í•˜ê³  ì½˜ì†”ì„ ì°¸ì¡°í•˜ì„¸ìš”.`
          );
        }
      };

      // --- UI ë° ìƒíƒœ ê´€ë¦¬ ë¡œì§ ---

      /**
       * ìµœì¢… JSON ê²°ê³¼ë¥¼ ì›í•˜ëŠ” í˜•ì‹(label ë°°ì—´ì„ í•œ ì¤„ë¡œ)ìœ¼ë¡œ í¬ë§·í•©ë‹ˆë‹¤.
       */
      const formatFinalJson = (prettyPrint) => {
        const displayResults = JSON.parse(
          JSON.stringify(globalState.allResults)
        );

        displayResults.forEach((result) => {
          if (result.label && Array.isArray(result.label)) {
            result.label = JSON.stringify(result.label);
          }
        });

        let jsonString = JSON.stringify(
          displayResults,
          null,
          prettyPrint ? 2 : 0
        );

        // ë¬¸ìì—´ë¡œ ë³€í™˜ëœ label ë°°ì—´ì„ ë‹¤ì‹œ JSON ë°°ì—´ í˜•íƒœë¡œ ë³µì›í•©ë‹ˆë‹¤.
        jsonString = jsonString.replace(
          /("label": )"(\[.*?\])"/gs,
          (match, p1, p2) => {
            const unescapedLabels = p2.replace(/\\"/g, '"');
            return `${p1}${unescapedLabels}`;
          }
        );

        return jsonString;
      };

      /**
       * í† í°ì— íƒœê·¸ë¥¼ í• ë‹¹í•˜ê³  B-I-O ê·œì¹™ì„ ì ìš©í•©ë‹ˆë‹¤.
       */
      const tagToken = (entityType) => {
        const index =
          globalState.isEditingTokenIndex !== -1
            ? globalState.isEditingTokenIndex
            : globalState.currentTokenIndex;

        if (index >= globalState.currentTokens.length) {
          return;
        }

        let newTag = "";

        if (entityType === "O") {
          newTag = "O";
        } else {
          let prevTag =
            index > 0 ? globalState.currentTokenTags[index - 1] : null;
          const prevEntityType = prevTag ? prevTag.replace(/^[BI]-/, "") : null;

          if (prevEntityType === entityType) {
            newTag = `I-${entityType}`;
          } else {
            newTag = `B-${entityType}`;
          }
        }

        globalState.currentTokenTags[index] = newTag;

        if (globalState.isEditingTokenIndex !== -1) {
          globalState.isEditingTokenIndex = -1;
        } else {
          globalState.currentTokenIndex++;
        }

        renderUI();
      };

      /**
       * í˜„ì¬ ë¬¸ì¥ì˜ JSON ê²°ê³¼ ìƒì„± (model_id ì œê±°ë¨)
       */
      const generateCurrentJson = () => {
        const input = globalState.inputs[globalState.currentInputIndex] || "";
        const labels = globalState.currentTokenTags;

        if (labels.length === 0) return {};

        return {
          input: input,
          // model_idëŠ” ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ ì œê±°ë¨
          label: labels,
        };
      };

      // í˜„ì¬ í† í° í‘œì‹œ ë° ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
      const updateAnnotationUI = () => {
        const totalTokens = globalState.currentTokens.length;
        const index =
          globalState.isEditingTokenIndex !== -1
            ? globalState.isEditingTokenIndex
            : globalState.currentTokenIndex;

        if (index < totalTokens) {
          elements.currentToken.textContent = globalState.currentTokens[index];
          elements.currentToken
            .closest(".current-token-wrapper")
            .querySelector("p").textContent = `(${index + 1}ë²ˆì§¸ í† í°)`;

          elements.nextInputBtn.classList.add("invisible", "opacity-0");
          elements.nextInputBtn.classList.remove("visible", "opacity-100");
          elements.tagButtons.forEach((btn) => (btn.disabled = false));
        } else {
          elements.currentToken.textContent = "âœ… ë¬¸ì¥ íƒœê¹… ì™„ë£Œ";
          elements.currentToken
            .closest(".current-token-wrapper")
            .querySelector("p").textContent =
            "ë‹¤ìŒ ë¬¸ì¥ìœ¼ë¡œ ë„˜ì–´ê°€ê±°ë‚˜ ìˆ˜ì •ì„ í™•ì¸í•˜ì„¸ìš”.";

          elements.nextInputBtn.classList.remove("invisible", "opacity-0");
          elements.nextInputBtn.classList.add("visible", "opacity-100");
          elements.tagButtons.forEach((btn) => (btn.disabled = true));
        }
      };

      // í† í° ëª©ë¡ (ìˆ˜ì • ê°€ëŠ¥ ì˜ì—­) ë Œë”ë§
      const renderTokenList = () => {
        elements.tokenList.innerHTML = "";
        if (globalState.currentTokens.length === 0) {
          elements.tokenList.innerHTML =
            '<p class="text-gray-400 text-sm italic">í† í°ì„ í• ë‹¹í•˜ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>';
          return;
        }

        globalState.currentTokens.forEach((token, idx) => {
          const tag = globalState.currentTokenTags[idx];
          const tagText = tag || "?";
          const colorClass = getTagColorClass(tag);

          const tokenElement = document.createElement("div");
          tokenElement.className = `token-tag ${colorClass}`;

          tokenElement.innerHTML = `
                    <span class="font-semibold">${token}</span>
                    <span class="ml-2 opacity-75 text-xs">
                        (<span class="inline-block min-w-[32px] text-center">${tagText}</span>)
                    </span>
                `;

          tokenElement.dataset.index = idx;

          // í´ë¦­ ì‹œ ìˆ˜ì • ëª¨ë“œë¡œ ì „í™˜
          tokenElement.onclick = () => enterEditMode(idx);

          elements.tokenList.appendChild(tokenElement);
        });
      };

      // ìˆ˜ì • ëª¨ë“œ ì§„ì…
      const enterEditMode = (index) => {
        globalState.isEditingTokenIndex = index;
        console.log(
          `[${globalState.currentTokens[index]}] í† í° ìˆ˜ì • ëª¨ë“œ ì§„ì…. ì•„ë˜ íƒœê¹… ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆŒëŸ¬ ìˆ˜ì •í•˜ì„¸ìš”.`
        );

        updateAnnotationUI();
        renderUI();
      };

      // ì „ì²´ UI ë Œë”ë§ (ìƒíƒœ ë³€ê²½ ì‹œ í˜¸ì¶œ)
      const renderUI = () => {
        const totalInputs = globalState.inputs.length;
        const currentInputIndex = globalState.currentInputIndex;
        const hasResults = globalState.allResults.length > 0;

        // í˜„ì¬ ì…ë ¥ ë¬¸ì¥ë“¤ì„ ëª¨ë‘ ì²˜ë¦¬í–ˆëŠ”ì§€ í™•ì¸
        const isCurrentBatchFinished =
          currentInputIndex >= totalInputs && totalInputs > 0;

        console.log(
          "[renderUI] totalInputs:",
          totalInputs,
          "currentInputIndex:",
          currentInputIndex,
          "isCurrentBatchFinished:",
          isCurrentBatchFinished
        );

        // 1. ì„¤ì • ë° ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
        elements.inputSentences.value = globalState.inputs.join("\n");
        elements.finalCount.textContent = globalState.allResults.length;

        const modelDisplay = loadedModelId || pendingModelId;
        const progressCountText = `${currentInputIndex} / ${totalInputs} ë¬¸ì¥`; // í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ì¸ë±ìŠ¤ ê¸°ì¤€

        // 1-1. ì§„í–‰ ìƒíƒœ ë¼ì¸ ì—…ë°ì´íŠ¸
        let statusText = "";
        if (isTokenizerReady) {
          statusText = `<span class="font-bold text-green-500">í† í¬ë‚˜ì´ì € ë¡œë”© ì™„ë£Œ!</span> (${modelDisplay})`;
        } else if (loadedModelId) {
          statusText = `í† í¬ë‚˜ì´ì € ë¡œë”© ì¤‘... (${modelDisplay})`;
        } else {
          statusText = `í† í¬ë‚˜ì´ì € ë¡œë”© ì „... (${modelDisplay})`;
        }
        elements.progressStatusLine.innerHTML = statusText;

        // 1-2. ë¬¸ì¥ ì¹´ìš´íŠ¸ ë¼ì¸ ì—…ë°ì´íŠ¸
        elements.progressCountLine.textContent = `í˜„ì¬ ì§„í–‰: ${progressCountText}`;

        // 2. ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€ ê´€ë¦¬
        // í˜„ì¬ ë°°ì¹˜ì˜ ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆê±°ë‚˜ ì…ë ¥ì´ ì—†ìœ¼ë©´ íƒœê¹… ì„¹ì…˜ ìˆ¨ê¹€
        if (isCurrentBatchFinished || totalInputs === 0) {
          elements.annotationSection.classList.add("hidden");
          elements.statusSection.classList.add("hidden");
          elements.currentJsonOutput.textContent = isCurrentBatchFinished
            ? "ì‘ì—… ì™„ë£Œ."
            : "{}";
        } else {
          elements.annotationSection.classList.remove("hidden");
          elements.statusSection.classList.remove("hidden");

          // 3. í˜„ì¬ ë¬¸ì¥ ì •ë³´ ì—…ë°ì´íŠ¸
          elements.currentSentenceDisplay.textContent =
            globalState.inputs[globalState.currentInputIndex];

          // 4. íƒœê¹… UI ì—…ë°ì´íŠ¸
          updateAnnotationUI();
          renderTokenList();
          elements.currentJsonOutput.textContent = JSON.stringify(
            generateCurrentJson(),
            null,
            2
          );
        }

        if (hasResults) {
          elements.finalResultsSection.classList.remove("hidden");
          elements.finalJsonOutput.textContent = formatFinalJson(true);
        } else {
          elements.finalResultsSection.classList.add("hidden");
        }

        // ì €ì¥ëœ ë°ì´í„° ëª©ë¡ë„ ë Œë”ë§
        renderSavedDataList();
      };

      // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---

      // í† í¬ë‚˜ì´ì € ì„¤ì • ëª¨ë‹¬ ì—´ê¸° ë²„íŠ¼ í•¸ë“¤ëŸ¬
      elements.openTokenizerModalBtn.onclick = openTokenizerConfigModal;

      // ì‘ì—… ì‹œì‘ ë²„íŠ¼ í•¸ë“¤ëŸ¬ (asyncë¡œ ë³€ê²½)
      elements.startBtn.onclick = async () => {
        const rawInputs = elements.inputSentences.value
          .split("\n")
          .map((s) => s.trim())
          .filter((s) => s.length > 0);
        const newModelId = pendingModelId; // ì„¤ì •ëœ ID ì‚¬ìš©

        console.log("[ì‘ì—… ì‹œì‘] ì…ë ¥ ë¬¸ì¥ ìˆ˜:", rawInputs.length);
        console.log("[ì‘ì—… ì‹œì‘] ë¶ˆëŸ¬ì˜¨ ë°ì´í„° ID:", globalState.loadedDataId);
        console.log("[ì‘ì—… ì‹œì‘] ê¸°ì¡´ ê²°ê³¼ ìˆ˜:", globalState.allResults.length);

        if (!newModelId) {
          showModal("ê²½ê³ ", "í† í¬ë‚˜ì´ì € IDë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.");
          return;
        }

        // í† í¬ë‚˜ì´ì € IDê°€ ë³€ê²½ë˜ì—ˆê±°ë‚˜ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì€ ê²½ìš° ì¬ë¡œë”©
        if (newModelId !== loadedModelId || !isTokenizerReady) {
          await initializeTokenizer(newModelId);
        }

        if (!isTokenizerReady) {
          return;
        }

        if (rawInputs.length === 0) {
          showModal("ê²½ê³ ", "íƒœê¹…í•  ë¬¸ì¥ì„ í•œ ì¤„ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        // ìƒˆ ì‘ì—… ì‹œì‘ ì‹œ ìƒíƒœ ì„¤ì •
        globalState.inputs = rawInputs;
        globalState.currentInputIndex = 0;
        // ì£¼ì˜: allResultsëŠ” ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ (ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìœ ì§€)
        // ìƒˆë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš°ì—ë§Œ ì´ˆê¸°í™”
        if (!globalState.loadedDataId) {
          globalState.allResults = [];
          console.log("[ì‘ì—… ì‹œì‘] ìƒˆ ì‘ì—… - allResults ì´ˆê¸°í™”");
        } else {
          console.log(
            "[ì‘ì—… ì‹œì‘] ì´ì–´ì„œ ì‘ì—… - allResults ìœ ì§€ (" +
              globalState.allResults.length +
              "ê°œ)"
          );
        }

        // ì²« ë¬¸ì¥ìœ¼ë¡œ ì´ë™
        await moveToNextInput(true);
      };

      // íƒœê·¸ ë²„íŠ¼ í´ë¦­ í•¸ë“¤ëŸ¬ (tagToken í•¨ìˆ˜ í˜¸ì¶œ)
      elements.tagButtons.forEach((button) => {
        button.onclick = (e) => {
          const entityType = e.target.dataset.tag;
          if (!entityType) return;

          if (
            globalState.currentTokens.length === 0 ||
            (globalState.currentTokenIndex >=
              globalState.currentTokens.length &&
              globalState.isEditingTokenIndex === -1)
          ) {
            console.warn(
              "í˜„ì¬ ì²˜ë¦¬í•  í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë‹¤ìŒ ë¬¸ì¥ìœ¼ë¡œ ë„˜ì–´ê°€ê±°ë‚˜ ì‘ì—…ì„ ì‹œì‘í•´ì£¼ì„¸ìš”."
            );
            return;
          }

          tagToken(entityType);
        };
      });

      // ë‹¤ìŒ ë¬¸ì¥ ë²„íŠ¼ í•¸ë“¤ëŸ¬ (asyncë¡œ ë³€ê²½)
      elements.nextInputBtn.onclick = async () => {
        await moveToNextInput(false);
      };

      elements.copyJsonBtn.onclick = () => {
        const jsonText = formatFinalJson(true);
        try {
          // execCommandë¥¼ ì‚¬ìš©í•˜ì—¬ í´ë¦½ë³´ë“œì— ë³µì‚¬
          const textarea = document.createElement("textarea");
          textarea.value = jsonText;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand("copy");
          document.body.removeChild(textarea);
          showModal("ë³µì‚¬ ì™„ë£Œ", "ìµœì¢… JSON ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch (err) {
          console.error("ë³µì‚¬ ì˜¤ë¥˜:", err);
          showModal(
            "ë³µì‚¬ ì‹¤íŒ¨",
            "í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”."
          );
        }
      };

      // ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
      elements.saveToStorageBtn.onclick = () => {
        if (globalState.allResults.length === 0) {
          showModal(
            "ê²½ê³ ",
            "ì €ì¥í•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € íƒœê¹… ì‘ì—…ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”."
          );
          return;
        }
        showSaveModal();
      };

      // ë‹¤ìŒ ë¬¸ì¥ìœ¼ë¡œ ì´ë™ ë° í† í°/íƒœê·¸ ì´ˆê¸°í™” (asyncë¡œ ë³€ê²½)
      const moveToNextInput = async (isStart) => {
        const totalInputs = globalState.inputs.length;
        const currentIdx = globalState.currentInputIndex;

        if (!isStart && currentIdx < totalInputs) {
          globalState.allResults.push(generateCurrentJson());
          globalState.currentInputIndex++;
        }

        const nextIndex = globalState.currentInputIndex;

        if (nextIndex < totalInputs) {
          const nextSentence = globalState.inputs[nextIndex];

          globalState.currentTokens = tokenize(nextSentence);

          globalState.currentTokenTags = new Array(
            globalState.currentTokens.length
          ).fill(null);
          globalState.currentTokenIndex = 0;

          if (globalState.currentTokens.length === 0) {
            showModal(
              "ê²½ê³ ",
              `"${nextSentence.substring(
                0,
                20
              )}..." ë¬¸ì¥ì˜ í† í°í™” ê²°ê³¼ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ë¬¸ì¥ìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.`
            );
            // model_id ì œê±°
            globalState.allResults.push({
              input: nextSentence,
              label: ["Error: Tokenization failed or resulted in empty array."],
            }); // ì˜¤ë¥˜ ë¬¸ì¥ë„ ê²°ê³¼ì— ì¶”ê°€
            globalState.currentInputIndex++;

            if (globalState.currentInputIndex < totalInputs) {
              // í† í°í™” ê²°ê³¼ê°€ ë¹„ì–´ìˆìœ¼ë©´ ë‹¤ìŒ ë¬¸ì¥ìœ¼ë¡œ ì¬ê·€ í˜¸ì¶œí•˜ì—¬ ì¦‰ì‹œ ë„˜ì–´ê°
              await moveToNextInput(true);
            }
            return;
          }
        }

        if (globalState.currentInputIndex >= totalInputs) {
          globalState.currentTokens = [];
          globalState.currentTokenTags = [];
        }

        renderUI();
      };

      // --- í‚¤ë³´ë“œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€ ---
      document.addEventListener("keydown", (e) => {
        const key = e.key;
        let buttonIndex = -1;
        const isInputFocused =
          document.activeElement.tagName === "TEXTAREA" ||
          document.activeElement.tagName === "INPUT";

        // 1. ëª¨ë‹¬ ë‹«ê¸° (Enter í‚¤)
        if (!elements.modal.classList.contains("hidden") && e.key === "Enter") {
          // í† í¬ë‚˜ì´ì € ì„¤ì • ëª¨ë‹¬ì˜ ì…ë ¥ì°½ì´ í¬ì»¤ìŠ¤ëœ ìƒíƒœì—ì„œ Enterë¥¼ ëˆ„ë¥´ë©´ 'ì ìš©' ë²„íŠ¼ í´ë¦­
          if (
            document.getElementById("modal-tokenizer-input") ===
            document.activeElement
          ) {
            e.preventDefault();
            elements.modalActionBtn.click();
            return;
          }
          // ì €ì¥ ëª¨ë‹¬ì˜ ì…ë ¥ì°½ì´ í¬ì»¤ìŠ¤ëœ ìƒíƒœì—ì„œ Enterë¥¼ ëˆ„ë¥´ë©´ 'ì €ì¥' ë²„íŠ¼ í´ë¦­
          else if (
            document.getElementById("modal-save-name-input") ===
            document.activeElement
          ) {
            e.preventDefault();
            elements.modalActionBtn.click();
            return;
          }
          // ì¼ë°˜ ì•Œë¦¼ ëª¨ë‹¬ì¼ ê²½ìš° 'í™•ì¸' ë²„íŠ¼ í´ë¦­
          else {
            e.preventDefault();
            elements.modalCloseBtn.click();
            return;
          }
        }

        // 2. ë¬¸ì¥ ì™„ë£Œ ë° ë‹¤ìŒ ë¬¸ì¥ìœ¼ë¡œ ì´ë™ (Enter í‚¤)
        if (
          key === "Enter" &&
          elements.nextInputBtn.classList.contains("visible") &&
          !isInputFocused
        ) {
          e.preventDefault();
          elements.nextInputBtn.click();
          return;
        }

        // 3. ì´ì „ í† í°ìœ¼ë¡œ ë˜ëŒë¦¬ê¸° (Backspace í‚¤)
        if (key === "Backspace") {
          if (
            !elements.annotationSection.classList.contains("hidden") &&
            !isInputFocused
          ) {
            e.preventDefault();

            let newIndex = globalState.currentTokenIndex;

            if (newIndex === globalState.currentTokens.length && newIndex > 0) {
              newIndex--;
            } else if (newIndex > 0) {
              newIndex--;
            }

            if (newIndex !== globalState.currentTokenIndex) {
              globalState.currentTokenIndex = newIndex;

              if (globalState.currentTokenTags[newIndex] !== undefined) {
                globalState.currentTokenTags[newIndex] = null;
              }

              globalState.isEditingTokenIndex = -1;

              renderUI();
            }
            return;
          }
        }

        // 4. íƒœê·¸ í• ë‹¹ (1~5 í‚¤)
        if (key >= "1" && key <= "5") {
          buttonIndex = parseInt(key) - 1;
        }

        if (buttonIndex !== -1 && buttonIndex < elements.tagButtons.length) {
          if (
            elements.annotationSection.classList.contains("hidden") ||
            isInputFocused
          ) {
            return;
          }

          const targetButton = elements.tagButtons[buttonIndex];

          if (targetButton && !targetButton.disabled) {
            e.preventDefault();

            // ì‹œê°ì  í”¼ë“œë°±
            targetButton.classList.add(
              "ring-4",
              "ring-offset-2",
              "ring-opacity-50",
              "ring-indigo-300"
            );

            setTimeout(() => {
              targetButton.classList.remove(
                "ring-4",
                "ring-offset-2",
                "ring-opacity-50",
                "ring-indigo-300"
              );
            }, 100);

            const entityType = targetButton.dataset.tag;
            tagToken(entityType);
          }
        }
      });
      // --- í‚¤ë³´ë“œ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë ---

      // ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ í† í¬ë‚˜ì´ì € ë¡œë”© ì‹œì‘ (pendingModelIdì˜ ê¸°ë³¸ê°’ì„ ì‚¬ìš©)
      window.onload = () => {
        initializeTokenizer(pendingModelId);
        renderSavedDataList(); // ì €ì¥ëœ ë°ì´í„° ëª©ë¡ ë Œë”ë§
      };
    </script>
  </body>
</html>
